<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal Educacional</title>
<style>
  /* [MANTENHA TODO O CSS ANTERIOR IGUAL] */
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 0;
    padding: 40px 20px;
    color: #ffffff;
    text-align: center;
    min-height: 100vh;
  }

  h1 {
    color: #ffffff;
    margin-bottom: 40px;
    font-size: 3.5em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    animation: fadeIn 1s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .main-buttons {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 30px;
    animation: slideUp 0.8s ease-out;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  button {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 20px 35px;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }

  button:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
  }

  .section {
    display: none;
    max-width: 1400px;
    margin: 40px auto;
    text-align: left;
    animation: fadeIn 0.5s ease-out;
  }

  .back-btn {
    background: rgba(0, 0, 0, 0.2);
    margin-bottom: 30px;
  }

  /* Bot√£o parar jogo - destaque vermelho */
  .stop-btn {
    background: rgba(220, 53, 69, 0.3);
    border: 2px solid rgba(220, 53, 69, 0.5);
    margin-top: 20px;
    padding: 15px 30px;
    font-size: 16px;
    font-weight: bold;
  }

  .stop-btn:hover {
    background: rgba(220, 53, 69, 0.5);
    border: 2px solid rgba(220, 53, 69, 0.8);
    transform: translateY(-3px);
  }

  .container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 30px;
    padding: 20px;
  }

  /* CARDS ESTILIZADOS PARA LIVROS */
  .book-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
    border-radius: 20px;
    padding: 30px 25px;
    text-align: center;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .book-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.6s;
  }

  .book-card:hover::before {
    left: 100%;
  }

  .book-card:hover {
    transform: translateY(-12px) scale(1.03);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
  }

  .book-new {
    border-top: 6px solid #4ade80;
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(255, 255, 255, 0.05));
  }

  .book-old {
    border-top: 6px solid #fbbf24;
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(255, 255, 255, 0.05));
  }

  .book-extra {
    border-top: 6px solid #a855f7;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(255, 255, 255, 0.05));
  }

  .book-icon {
    font-size: 3.5em;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
  }

  .book-card:hover .book-icon {
    transform: scale(1.2) rotate(5deg);
  }

  .book-title {
    font-size: 1.4em;
    font-weight: 700;
    margin: 0;
    color: #ffffff;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    line-height: 1.3;
  }

  .book-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-new {
    background: linear-gradient(45deg, #4ade80, #22c55e);
    box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4);
  }

  .badge-old {
    background: linear-gradient(45deg, #fbbf24, #f59e0b);
    box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
  }

  .badge-extra {
    background: linear-gradient(45deg, #a855f7, #8b5cf6);
    box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
  }

  .book-content {
    margin-top: 20px;
    max-height: 0;
    overflow: hidden;
    transition: all 0.5s ease;
    opacity: 0;
    width: 100%;
  }

  .book-card.expanded .book-content {
    max-height: 800px; /* Aumentei para acomodar mais arquivos */
    opacity: 1;
    margin-top: 15px;
  }

  .content-files {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 15px;
    margin-top: 10px;
    max-height: 600px; /* Aumentei a altura m√°xima */
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1);
  }

  /* Custom scrollbar para Webkit browsers */
  .content-files::-webkit-scrollbar {
    width: 8px;
  }

  .content-files::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
  }

  .content-files::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }

  .content-files::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }

  .file-item {
    margin: 8px 0;
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 10px;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
    text-align: left;
  }

  .file-item:hover {
    background: rgba(255, 255, 255, 0.15);
    border-left: 3px solid #00f3ff;
    transform: translateX(5px);
  }

  .file-item a {
    color: #ffffff;
    text-decoration: none;
    display: flex;
    align-items: center;
    font-size: 0.95em;
  }

  .file-item a:hover {
    color: #00f3ff;
  }

  .file-icon {
    margin-right: 10px;
    font-size: 1.2em;
  }

  .pdf-icon {
    color: #ff6b6b;
  }

  .expand-indicator {
    margin-top: 15px;
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.7);
    transition: all 0.3s ease;
  }

  .book-card:hover .expand-indicator {
    color: #ffffff;
  }

  .book-card.expanded .expand-indicator {
    transform: rotate(180deg);
    color: #00f3ff;
  }

  .game-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
    margin-top: 30px;
  }

  .game-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(8px);
  }

  .game-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 15px 45px rgba(31, 38, 135, 0.2);
  }

  .game-card img {
    width: 100%;
    border-radius: 15px;
    transition: transform 0.3s ease;
  }

  .game-card:hover img {
    transform: scale(1.05);
  }

  iframe {
    width: 100%;
    height: 650px;
    border: none;
    border-radius: 20px;
    margin-top: 30px;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
  }

  h2 {
    color: #ffffff;
    font-size: 2.5em;
    margin: 50px 0 30px;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
    position: relative;
    display: inline-block;
  }

  h2::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, transparent, #00f3ff, transparent);
    border-radius: 2px;
  }

  .hidden { display: none; }

  /* Container do iframe com bot√£o parar */
  .iframe-container {
    position: relative;
    margin-top: 30px;
  }

  .iframe-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
  }

  .loading {
    text-align: center;
    padding: 40px;
    font-style: italic;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1em;
  }

  .loading::after {
    content: ' ‚ú®';
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .error {
    text-align: center;
    padding: 30px;
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
    border-radius: 15px;
    margin: 10px 0;
    border: 1px solid rgba(255, 107, 107, 0.3);
  }

  .empty-folder {
    text-align: center;
    padding: 20px;
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    margin: 10px 0;
  }

  /* Loading r√°pido para conte√∫do */
  .quick-loading {
    text-align: center;
    padding: 10px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9em;
  }

  /* Indicador de carregamento de mais arquivos */
  .loading-more {
    text-align: center;
    padding: 15px;
    color: rgba(255, 255, 255, 0.6);
    font-style: italic;
    font-size: 0.9em;
  }

  .loading-more::after {
    content: ' üìö Carregando mais arquivos...';
    animation: pulse 1.5s infinite;
  }

  /* NOVO CSS PARA SETINHAS DE EXPANDIR/RECOLHER */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 10px 20px;
    border-radius: 15px;
    margin: 30px auto;
    max-width: 500px;
  }

  .section-header:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .section-header h2 {
    margin: 0;
    transition: all 0.3s ease;
  }

  .section-header:hover h2 {
    transform: scale(1.02);
  }

  .toggle-icon {
    font-size: 1.8em;
    transition: all 0.3s ease;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 5px;
  }

  .section-header:hover .toggle-icon {
    color: #ffffff;
    transform: scale(1.2);
  }

  /* ALTERA√á√ÉO: Se√ß√µes come√ßam retra√≠das por padr√£o */
  .book-section {
    /* Inicia com as se√ß√µes retra√≠das */
  }

  .section-collapsed .toggle-icon {
    transform: rotate(-90deg);
  }

  .section-collapsed .container {
    display: none;
  }

  .section-collapsed h2::after {
    width: 120px;
    background: linear-gradient(90deg, transparent, #ff6b6b, transparent);
  }

  @media (max-width: 768px) {
    h1 { font-size: 2.5em; }
    .container { grid-template-columns: 1fr; gap: 20px; padding: 10px; }
    button { width: 100%; }
    .main-buttons { flex-direction: column; }
    .iframe-controls { flex-direction: column; }
    .book-card { padding: 25px 20px; min-height: 160px; }
    .book-icon { font-size: 3em; }
    .book-title { font-size: 1.2em; }
    .section-header { flex-direction: column; gap: 10px; }
    .book-card.expanded .book-content { max-height: 600px; }
    .content-files { max-height: 500px; }
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

<h1>üåê Portal Educacional</h1>

<!-- P√ÅGINA INICIAL -->
<div id="menuPrincipal" class="main-buttons">
  <button onclick="abrirSecao('teacher')">üë©‚Äçüè´ Teacher</button>
  <button onclick="abrirSecao('admin')">üè´ Administra√ß√£o</button>
  <button onclick="abrirSecao('alunos')">üéÆ Alunos</button>
</div>

<!-- TEACHER -->
<div id="teacher" class="section">
  <button class="back-btn" onclick="voltar()">‚¨Ö Voltar ao Portal</button>

  <!-- Se√ß√£o Livros Novos com setinha -->
  <div id="secaoNovos" class="book-section section-collapsed">
    <div class="section-header" onclick="alternarSecao('novos')">
      <h2>üìó Livros Novos</h2>
      <div class="toggle-icon">‚ñº</div>
    </div>
    <div class="container" id="listaNovos">
      <div class="loading">Carregando materiais m√°gicos...</div>
    </div>
  </div>

  <!-- Se√ß√£o Livros Antigos com setinha -->
  <div id="secaoAntigos" class="book-section section-collapsed">
    <div class="section-header" onclick="alternarSecao('antigos')">
      <h2>üìï Livros Antigos</h2>
      <div class="toggle-icon">‚ñº</div>
    </div>
    <div class="container" id="listaAntigos">
      <div class="loading">Carregando materiais m√°gicos...</div>
    </div>
  </div>

  <!-- Se√ß√£o Materiais Extras com setinha -->
  <div id="secaoExtras" class="book-section section-collapsed">
    <div class="section-header" onclick="alternarSecao('extras')">
      <h2>üìò Materiais Extras</h2>
      <div class="toggle-icon">‚ñº</div>
    </div>
    <div class="container" id="listaExtras">
      <div class="loading">Carregando materiais m√°gicos...</div>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="admin" class="section">
  <button class="back-btn" onclick="voltar()">‚¨Ö Voltar ao Portal</button>
  <h2>√Årea Administrativa</h2>
  <p>Conte√∫do protegido por senha.</p>
</div>

<!-- ALUNOS -->
<div id="alunos" class="section">
  <button class="back-btn" onclick="voltar()">‚¨Ö Voltar ao Portal</button>

  <div class="main-buttons">
    <button onclick="abrirSubSecao('games')">üéÆ Games</button>
    <button onclick="abrirSubSecao('extrasAlunos')">üìò Extra Activities</button>
  </div>

  <!-- Games -->
  <div id="games" class="hidden">
    <h2>Escolha um jogo para come√ßar:</h2>
    <div class="game-list">
      <div class="game-card" onclick="abrirJogo('https://www.gamestolearnenglish.com/')">
        <img src="https://www.gamestolearnenglish.com/wp-content/uploads/2021/07/screenshot-homepage.png" alt="Games to Learn English">
        <p><strong>Games to Learn English</strong></p>
      </div>
      <div class="game-card" onclick="abrirJogoExterno('https://www.foodguessr.com/game/daily')">
        <img src="https://www.foodguessr.com/images/og-image.jpg" alt="FoodGuessr">
        <p><strong>FoodGuessr</strong></p>
      </div>
      <div class="game-card" onclick="abrirJogoExterno('https://garticphone.com/en')">
        <img src="https://garticphone.com/images/share.png" alt="Gartic Phone">
        <p><strong>Gartic Phone</strong></p>
      </div>
      <div class="game-card" onclick="abrirJogo('https://zty.pe/')">
        <img src="https://zty.pe/images/ztype.png" alt="ZType">
        <p><strong>ZType - Typing Game</strong></p>
      </div>
    </div>
    
    <!-- Container do iframe com controles -->
    <div id="iframeContainer" class="hidden iframe-container">
      <iframe id="gameIframe"></iframe>
      <div class="iframe-controls">
        <button class="back-btn" onclick="voltarParaGames()">‚¨Ö Voltar para Games</button>
        <button class="stop-btn" onclick="pararJogo()">‚èπÔ∏è Parar Jogo</button>
      </div>
    </div>
  </div>

  <!-- Extra Activities -->
  <div id="extrasAlunos" class="hidden">
    <h2>Extra Activities</h2>
    <p>Conte√∫do em desenvolvimento...</p>
  </div>
</div>

<script>
const SENHA = "2020";

// CACHE PARA CONTE√öDO J√Å CARREGADO
const cacheConteudo = new Map();
const cacheLivros = new Map();

// ALTERA√á√ÉO: Todas as se√ß√µes come√ßam retra√≠das
let secoesExpandidas = {
  novos: false,  // Alterado para false
  antigos: false, // Alterado para false
  extras: false  // Alterado para false
};

// ABRIR SE√á√ÉO COM OU SEM SENHA
function abrirSecao(secao) {
  if (secao === 'teacher' || secao === 'admin') {
    const senhaDigitada = prompt("üîê Digite a senha:");
    if(senhaDigitada !== SENHA){
      alert("Senha incorreta!");
      return;
    }
  }
  document.getElementById('menuPrincipal').style.display = 'none';
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.getElementById(secao).style.display = 'block';

  // Carregar materiais apenas quando Teacher √© aberto
  if(secao === 'teacher') carregarPastas();
}

// VOLTAR PARA MENU
function voltar() {
  // Para o jogo antes de voltar
  pararJogo();
  
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.getElementById('menuPrincipal').style.display = 'flex';
  document.getElementById('iframeContainer').classList.add('hidden');
}

// VOLTAR PARA LISTA DE GAMES (sem parar completamente)
function voltarParaGames() {
  document.getElementById('iframeContainer').classList.add('hidden');
}

// PARAR JOGO COMPLETAMENTE - Esta fun√ß√£o para realmente o jogo
function pararJogo() {
  const iframe = document.getElementById('gameIframe');
  
  // M√©todo 1: Remover o src completamente
  iframe.src = 'about:blank';
  
  // M√©todo 2: Tentar parar qualquer √°udio/v√≠deo
  try {
    iframe.contentWindow.postMessage('stop', '*');
  } catch (e) {
    // Ignora erros de cross-origin
  }
  
  // M√©todo 3: Esconder o iframe
  document.getElementById('iframeContainer').classList.add('hidden');
  
  console.log('Jogo parado completamente');
}

// ABRIR SUBSE√á√ÉO DENTRO DE ALUNOS
function abrirSubSecao(id) {
  // Para qualquer jogo rodando antes de mudar de se√ß√£o
  pararJogo();
  
  document.getElementById('games').classList.add('hidden');
  document.getElementById('extrasAlunos').classList.add('hidden');
  document.getElementById('iframeContainer').classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
}

// ABRIR JOGO NO IFRAME
function abrirJogo(url) {
  const iframe = document.getElementById('gameIframe');
  iframe.src = url;
  document.getElementById('iframeContainer').classList.remove('hidden');
}

// ABRIR JOGO EXTERNO EM NOVA ABA
function abrirJogoExterno(url) {
  window.open(url, '_blank');
}

// === NOVAS FUN√á√ïES PARA EXPANDIR/RECOLHER SE√á√ïES COM SETINHAS ===

// Alternar uma se√ß√£o espec√≠fica
function alternarSecao(tipo) {
  const secao = document.getElementById(`secao${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
  
  if (secoesExpandidas[tipo]) {
    secao.classList.add('section-collapsed');
    secoesExpandidas[tipo] = false;
  } else {
    secao.classList.remove('section-collapsed');
    secoesExpandidas[tipo] = true;
  }
}

// === FUN√á√ÉO PARA CARREGAR MATERIAIS DO DRIVE (Teacher) ===
const API_KEY = "AIzaSyBpdK2e9XfRgQdcf-cnx4nV1z6BaDeeYWM";
const FOLDER_ID = "1pOe6fvSe6w08taSC3UnoOQnPUQAZcdw8";

// ID da pasta English para processamento especial
const ENGLISH_FOLDER_NAME = "English";

// Fun√ß√£o para listar TODAS as pastas principais e processar a pasta English
async function listarPastasPrincipais() {
  try {
    console.log('Buscando pastas principais...');
    
    // Buscar todas as pastas no n√≠vel principal
    const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType='application/vnd.google-apps.folder'&key=${API_KEY}&fields=files(id,name,mimeType,webViewLink)&orderBy=name`;
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.files || data.files.length === 0) {
      console.log('Nenhuma pasta encontrada');
      return [];
    }
    
    console.log(`Encontradas ${data.files.length} pastas principais`);
    
    // Processar todas as pastas
    const todasPastas = [];
    
    for (const item of data.files) {
      if (item.name === ENGLISH_FOLDER_NAME) {
        // Se for a pasta English, buscar seu conte√∫do interno
        console.log('Encontrada pasta English, processando conte√∫do interno...');
        const conteudoEnglish = await carregarConteudoPastaEnglish(item.id);
        todasPastas.push(...conteudoEnglish);
      } else {
        // Para outras pastas, adicionar normalmente
        todasPastas.push({
          id: item.id,
          nome: item.name,
          tipo: item.mimeType,
          link: item.webViewLink,
          conteudo: null,
          origem: 'principal'
        });
      }
    }
    
    console.log(`Total de itens ap√≥s processamento: ${todasPastas.length}`);
    return todasPastas;
  } catch (error) {
    console.error('Erro ao buscar pastas principais:', error);
    throw error;
  }
}

// Fun√ß√£o especial para carregar conte√∫do da pasta English
async function carregarConteudoPastaEnglish(englishFolderId) {
  try {
    console.log(`Carregando conte√∫do da pasta English (ID: ${englishFolderId})`);
    
    const url = `https://www.googleapis.com/drive/v3/files?q='${englishFolderId}'+in+parents&key=${API_KEY}&fields=files(id,name,mimeType,webViewLink)&orderBy=name`;
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.files || data.files.length === 0) {
      console.log('Pasta English est√° vazia');
      return [];
    }
    
    // Processar cada item dentro da pasta English
    const itensEnglish = data.files.map(item => ({
      id: item.id,
      nome: item.name, // REMOVI o prefixo "English - " para ficar mais limpo
      tipo: item.mimeType,
      link: item.webViewLink,
      conteudo: null,
      origem: 'english'
    }));
    
    console.log(`Encontrados ${itensEnglish.length} itens dentro da pasta English`);
    return itensEnglish;
  } catch (error) {
    console.error('Erro ao carregar pasta English:', error);
    return [];
  }
}

// NOVA FUN√á√ÉO: Carregar TODOS os arquivos de uma pasta com pagina√ß√£o
async function carregarTodosArquivosPasta(pastaId) {
  let todosArquivos = [];
  let nextPageToken = null;
  
  try {
    do {
      // Construir URL com pagina√ß√£o
      let url = `https://www.googleapis.com/drive/v3/files?q='${pastaId}'+in+parents&key=${API_KEY}&fields=files(id,name,mimeType,webViewLink,webContentLink),nextPageToken&orderBy=name&pageSize=1000`;
      
      if (nextPageToken) {
        url += `&pageToken=${nextPageToken}`;
      }
      
      console.log(`Carregando p√°gina da pasta ${pastaId}...`);
      
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`Erro HTTP: ${response.status}`);
      }
      
      const data = await response.json();
      
      // Adicionar arquivos da p√°gina atual
      if (data.files && data.files.length > 0) {
        const arquivosPagina = data.files.map(item => ({
          id: item.id,
          nome: item.name,
          tipo: item.mimeType,
          // Usar sempre o link de visualiza√ß√£o para evitar download
          link: item.webViewLink || `https://drive.google.com/file/d/${item.id}/view`
        }));
        
        todosArquivos = todosArquivos.concat(arquivosPagina);
        console.log(`Adicionados ${arquivosPagina.length} arquivos. Total: ${todosArquivos.length}`);
      }
      
      // Verificar se h√° mais p√°ginas
      nextPageToken = data.nextPageToken || null;
      
    } while (nextPageToken);
    
    console.log(`Total de arquivos carregados da pasta ${pastaId}: ${todosArquivos.length}`);
    return todosArquivos;
    
  } catch (error) {
    console.error(`Erro ao carregar pasta ${pastaId}:`, error);
    throw error;
  }
}

// Fun√ß√£o para carregar conte√∫do de m√∫ltiplas pastas de uma vez
async function carregarConteudoMultiplasPastas(pastaIds) {
  try {
    console.log(`Carregando conte√∫do de ${pastaIds.length} pastas...`);
    
    // Carregar todas as pastas em paralelo
    const promises = pastaIds.map(async (pastaId) => {
      if (cacheConteudo.has(pastaId)) {
        console.log(`Usando cache para pasta ${pastaId}`);
        return { pastaId, conteudo: cacheConteudo.get(pastaId) };
      }
      
      try {
        // Usar a nova fun√ß√£o com pagina√ß√£o
        const conteudo = await carregarTodosArquivosPasta(pastaId);
        
        // Salvar no cache
        cacheConteudo.set(pastaId, conteudo);
        
        return { pastaId, conteudo };
      } catch (error) {
        console.error(`Erro ao carregar pasta ${pastaId}:`, error);
        return { pastaId, conteudo: [], error: error.message };
      }
    });
    
    const resultados = await Promise.allSettled(promises);
    
    // Processar resultados
    const conteudos = {};
    resultados.forEach(resultado => {
      if (resultado.status === 'fulfilled') {
        conteudos[resultado.value.pastaId] = resultado.value.conteudo;
      }
    });
    
    return conteudos;
  } catch (error) {
    console.error('Erro ao carregar m√∫ltiplas pastas:', error);
    return {};
  }
}

// Fun√ß√£o para classificar os livros (FILTRAGEM CORRIGIDA - VERS√ÉO FINAL)
function classificarLivros(livros) {
  const novos = [];
  const antigos = [];
  const extras = [];

  livros.forEach(livro => {
    const nome = livro.nome.toLowerCase();
    
    // CRIT√âRIOS CORRIGIDOS - VERS√ÉO FINAL:
    
    // 1. NOVOS: Apenas os que cont√©m "new" ou "3rd" explicitamente
    if (nome.includes('new') || nome.includes('3rd')) {
      novos.push(livro);
    }
    // 2. EXTRAS: Apenas materiais de apoio espec√≠ficos
    else if (nome.includes('audio') || 
             nome.includes('answer') || 
             nome.includes('checking') ||
             nome.includes('peic') ||
             nome.includes('extra activities') ||
             nome.includes('material')) {
      extras.push(livro);
    }
    // 3. ANTIGOS: Todo o resto (incluindo W2, W10, Teens, etc.)
    else {
      antigos.push(livro);
    }
  });

  return { novos, antigos, extras };
}

// Fun√ß√£o para criar HTML dos livros estilizados
function criarEstruturaHTML(livros, containerId, categoria) {
  const container = document.getElementById(containerId);
  
  if (!livros || livros.length === 0) {
    container.innerHTML = `<div class="empty-folder">Nenhum livro encontrado na categoria "${categoria}"</div>`;
    return;
  }
  
  let html = '';
  
  livros.forEach(livro => {
    const classificacao = classificarItem(livro);
    const classeCSS = `book-${classificacao}`;
    const badgeCSS = `badge-${classificacao}`;
    const icon = getBookIcon(livro.nome);
    
    html += `
      <div class="book-card ${classeCSS}" onclick="alternarLivro(this, '${livro.id}')">
        <div class="book-badge ${badgeCSS}">${getBadgeText(classificacao)}</div>
        <div class="book-icon">${icon}</div>
        <h3 class="book-title">${livro.nome}</h3>
        <div class="expand-indicator">‚ñº Clique para expandir ‚ñº</div>
        <div class="book-content" id="conteudo-${livro.id}">
          <div class="quick-loading">Carregando...</div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Fun√ß√£o para obter √≠cone baseado no nome do livro
function getBookIcon(nomeLivro) {
  const nome = nomeLivro.toLowerCase();
  if (nome.includes('english') || nome.includes('ingl√™s')) return 'üåç';
  if (nome.includes('math') || nome.includes('matem√°tica')) return 'üî¢';
  if (nome.includes('science') || nome.includes('ci√™ncia')) return 'üî¨';
  if (nome.includes('history') || nome.includes('hist√≥ria')) return 'üìú';
  if (nome.includes('art') || nome.includes('arte')) return 'üé®';
  if (nome.includes('music') || nome.includes('m√∫sica')) return 'üéµ';
  if (nome.includes('workbook')) return 'üìù';
  if (nome.includes('audio')) return 'üéß';
  if (nome.includes('answer')) return '‚úÖ';
  return 'üìö';
}

// Fun√ß√£o para obter texto do badge
function getBadgeText(classificacao) {
  switch(classificacao) {
    case 'new': return 'Novo';
    case 'old': return 'Antigo';
    case 'extra': return 'Extra';
    default: return 'Livro';
  }
}

// Fun√ß√£o para classificar um item individual
function classificarItem(item) {
  const nome = item.nome.toLowerCase();
  
  if (nome.includes('new') || nome.includes('3rd')) return 'new';
  if (nome.includes('audio') || 
      nome.includes('answer') || 
      nome.includes('checking') ||
      nome.includes('peic') ||
      nome.includes('extra activities') ||
      nome.includes('material')) return 'extra';
  
  return 'old';
}

// Fun√ß√£o para alternar expans√£o de um livro
async function alternarLivro(elemento, pastaId) {
  elemento.classList.toggle('expanded');
  
  const conteudoDiv = elemento.querySelector('.book-content');
  const loadingDiv = conteudoDiv.querySelector('.quick-loading');
  
  // Se est√° expandindo e ainda n√£o carregou o conte√∫do
  if (elemento.classList.contains('expanded') && loadingDiv) {
    await carregarConteudoLivro(pastaId, conteudoDiv);
  }
}

// NOVA FUN√á√ÉO: Ordenar arquivos numericamente
function ordenarArquivosNumericamente(arquivos) {
  return arquivos.sort((a, b) => {
    // Extrair n√∫meros dos nomes dos arquivos
    const numA = extrairNumero(a.nome);
    const numB = extrairNumero(b.nome);
    
    // Se ambos t√™m n√∫meros, ordenar numericamente
    if (numA !== null && numB !== null) {
      return numA - numB;
    }
    
    // Se apenas um tem n√∫mero, o com n√∫mero vem primeiro
    if (numA !== null && numB === null) return -1;
    if (numA === null && numB !== null) return 1;
    
    // Se nenhum tem n√∫mero, ordenar alfabeticamente
    return a.nome.localeCompare(b.nome);
  });
}

// FUN√á√ÉO AUXILIAR: Extrair n√∫mero do nome do arquivo
function extrairNumero(nome) {
  // Procura por n√∫meros no formato: Lesson 1, Unit 2, Chapter 3, etc.
  const match = nome.match(/(\d+)/);
  return match ? parseInt(match[1]) : null;
}

// Fun√ß√£o para carregar conte√∫do de um livro espec√≠fico
async function carregarConteudoLivro(pastaId, containerDiv) {
  try {
    console.log(`Carregando conte√∫do da pasta ${pastaId}...`);
    
    // Verificar se j√° temos no cache
    if (cacheConteudo.has(pastaId)) {
      console.log(`Usando cache para pasta ${pastaId}`);
      const arquivosOrdenados = ordenarArquivosNumericamente(cacheConteudo.get(pastaId));
      exibirConteudo(arquivosOrdenados, containerDiv);
      return;
    }
    
    // Mostrar indicador de carregamento
    containerDiv.innerHTML = '<div class="loading-more">Carregando todos os arquivos...</div>';
    
    // Usar a nova fun√ß√£o com pagina√ß√£o para carregar TODOS os arquivos
    let arquivos = await carregarTodosArquivosPasta(pastaId);
    
    // ORDENAR OS ARQUIVOS NUMERICAMENTE
    arquivos = ordenarArquivosNumericamente(arquivos);
    
    // Salvar no cache
    cacheConteudo.set(pastaId, arquivos);
    
    // Exibir conte√∫do
    exibirConteudo(arquivos, containerDiv);
    
  } catch (error) {
    console.error(`Erro ao carregar conte√∫do da pasta ${pastaId}:`, error);
    containerDiv.innerHTML = `<div class="error">Erro ao carregar conte√∫do: ${error.message}</div>`;
  }
}

// Fun√ß√£o para exibir conte√∫do na interface
function exibirConteudo(arquivos, containerDiv) {
  if (!arquivos || arquivos.length === 0) {
    containerDiv.innerHTML = '<div class="empty-folder">Nenhum arquivo encontrado</div>';
    return;
  }
  
  let html = '<div class="content-files">';
  
  // Adicionar contador de arquivos
  html += `<div style="text-align: center; padding: 10px; color: rgba(255,255,255,0.7); font-size: 0.9em;">
            üìö Total de ${arquivos.length} arquivos
          </div>`;
  
  arquivos.forEach(arquivo => {
    const icon = getFileIcon(arquivo.tipo);
    html += `
      <div class="file-item">
        <a href="${arquivo.link}" target="_blank" rel="noopener">
          <span class="file-icon ${icon.class}">${icon.symbol}</span>
          ${arquivo.nome}
        </a>
      </div>
    `;
  });
  
  html += '</div>';
  containerDiv.innerHTML = html;
}

// Fun√ß√£o para obter √≠cone baseado no tipo de arquivo
function getFileIcon(mimeType) {
  if (mimeType.includes('pdf')) return { symbol: 'üìÑ', class: 'pdf-icon' };
  if (mimeType.includes('document')) return { symbol: 'üìù', class: '' };
  if (mimeType.includes('spreadsheet')) return { symbol: 'üìä', class: '' };
  if (mimeType.includes('presentation')) return { symbol: 'üìΩÔ∏è', class: '' };
  if (mimeType.includes('image')) return { symbol: 'üñºÔ∏è', class: '' };
  if (mimeType.includes('audio')) return { symbol: 'üéµ', class: '' };
  if (mimeType.includes('video')) return { symbol: 'üé¨', class: '' };
  if (mimeType.includes('folder')) return { symbol: 'üìÅ', class: '' };
  return { symbol: 'üìé', class: '' };
}

// FUN√á√ÉO PRINCIPAL PARA CARREGAR TODOS OS MATERIAIS
async function carregarPastas() {
  try {
    console.log('Iniciando carregamento de pastas...');
    
    // Buscar todas as pastas principais
    const pastasPrincipais = await listarPastasPrincipais();
    
    if (pastasPrincipais.length === 0) {
      document.getElementById('listaNovos').innerHTML = '<div class="error">Nenhuma pasta encontrada no Drive</div>';
      document.getElementById('listaAntigos').innerHTML = '<div class="error">Nenhuma pasta encontrada no Drive</div>';
      document.getElementById('listaExtras').innerHTML = '<div class="error">Nenhuma pasta encontrada no Drive</div>';
      return;
    }
    
    console.log(`Processando ${pastasPrincipais.length} pastas...`);
    
    // Classificar os livros
    const { novos, antigos, extras } = classificarLivros(pastasPrincipais);
    
    console.log(`Classifica√ß√£o: ${novos.length} novos, ${antigos.length} antigos, ${extras.length} extras`);
    
    // Criar estrutura HTML para cada categoria
    criarEstruturaHTML(novos, 'listaNovos', 'Novos');
    criarEstruturaHTML(antigos, 'listaAntigos', 'Antigos');
    criarEstruturaHTML(extras, 'listaExtras', 'Extras');
    
    // Carregar conte√∫do das pastas em background para melhor performance
    const todasPastasIds = [...novos, ...antigos, ...extras].map(pasta => pasta.id);
    console.log(`Carregando conte√∫do de ${todasPastasIds.length} pastas em background...`);
    
    // Carregar em background sem bloquear a interface
    setTimeout(() => {
      carregarConteudoMultiplasPastas(todasPastasIds)
        .then(() => console.log('Conte√∫do carregado em background'))
        .catch(err => console.error('Erro no carregamento em background:', err));
    }, 1000);
    
  } catch (error) {
    console.error('Erro ao carregar pastas:', error);
    
    // Exibir erros espec√≠ficos em cada container
    const errorMsg = `<div class="error">Erro ao carregar: ${error.message}</div>`;
    document.getElementById('listaNovos').innerHTML = errorMsg;
    document.getElementById('listaAntigos').innerHTML = errorMsg;
    document.getElementById('listaExtras').innerHTML = errorMsg;
  }
}

// Inicializar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
  console.log('Portal Educacional inicializado');
  // As se√ß√µes j√° come√ßam retra√≠das por padr√£o devido √† classe section-collapsed no HTML
});
</script>
</body>
</html>
